<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Cronômetro Moderno</title>
  <style>
    :root {
      --bg: #f8f8f8;
      --text: #222;
      --card: rgba(0, 0, 0, 0.05);
      --button-bg: #000;
      --button-text: #fff;
    }

    .dark {
      --bg: #111;
      --text: #f2f2f2;
      --card: rgba(255, 255, 255, 0.08);
      --button-bg: #fff;
      --button-text: #000;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      overflow: hidden;
    }

    #timer {
      font-size: 18vw;
      font-weight: 600;
      margin-bottom: 40px;
    }

    #marks {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--card);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 3.2vw;
      max-height: 40vh;
      overflow-y: auto;
      min-width: 110px;
    }

    #history {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: var(--card);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 2.8vw;
      max-height: 30vh;
      overflow-y: auto;
      min-width: 140px;
    }

    #pauseButton, #themeButton {
      position: fixed;
      bottom: 40px;
      font-size: 4.8vw;
      border: none;
      padding: 12px 24px;
      border-radius: 30px;
      cursor: pointer;
      opacity: 0.85;
      transition: background 0.2s;
      background: var(--button-bg);
      color: var(--button-text);
    }

    #pauseButton:hover, #themeButton:hover {
      opacity: 1;
    }

    #pauseButton {
      left: 20px;
    }

    #themeButton {
      right: 20px;
    }

    #pauseDialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg);
      color: var(--text);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      z-index: 10;
      display: none;
      text-align: center;
    }

    .btn {
      margin: 10px;
      padding: 12px 20px;
      font-size: 4vw;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .continue-btn {
      background-color: #0a84ff;
      color: white;
    }

    .delete-btn {
      background-color: #ff3b30;
      color: white;
    }
  </style>
</head>
<body>
  <div id="timer">00:00.000</div>
  <div id="marks"></div>
  <div id="history"><strong>Histórico:</strong><br></div>
  <button id="pauseButton" onclick="pause()">Pausar</button>
  <button id="themeButton" onclick="toggleTheme()">Dark</button>

  <div id="pauseDialog">
    <p>Cronômetro pausado</p>
    <button class="btn continue-btn" onclick="resumeTimer()">Continuar</button>
    <button class="btn delete-btn" onclick="deleteTimer()">Excluir</button>
  </div>

  <script>
    let startTime, isRunning = false, interval, marks = [], lastClickTime, currentSession, longPressTimer;
    let history = JSON.parse(localStorage.getItem("history") || "[]");

    const timerEl = document.getElementById("timer");
    const marksEl = document.getElementById("marks");
    const historyEl = document.getElementById("history");
    const themeButton = document.getElementById("themeButton");

    function formatTime(ms) {
      const min = String(Math.floor(ms / 60000)).padStart(2, '0');
      const sec = String(Math.floor((ms % 60000) / 1000)).padStart(2, '0');
      const msStr = String(ms % 1000).padStart(3, '0');
      return `${min}:${sec}.${msStr}`;
    }

    function formatAverage(ms) {
      return (ms / 1000).toFixed(2) + "s";
    }

    function updateTimer() {
      const now = Date.now();
      timerEl.textContent = formatTime(now - startTime);
    }

    function updateMarksDisplay() {
      marksEl.innerHTML = "<strong>Marcações:</strong><br>";
      let total = 0;
      marks.forEach((m, i) => {
        total += m.diff;
        marksEl.innerHTML += `#${i + 1}: ${formatTime(m.time)}<br>+${formatTime(m.diff)}<br>`;
      });
      if (marks.length > 1) {
        const avg = total / (marks.length - 1);
        marksEl.innerHTML += `<br><em>Média: ${formatAverage(avg)}</em>`;
      }
    }

    function updateHistoryDisplay() {
      historyEl.innerHTML = "<strong>Histórico:</strong><br>";
      history.forEach((s, i) => {
        const div = document.createElement("div");
        div.style.cursor = "pointer";
        div.innerHTML = `⏱ ${s.date}<br>`;
        s.marks.forEach((m, j) => {
          div.innerHTML += `&nbsp;&nbsp;#${j + 1}: ${formatTime(m.time)}<br>`;
        });
        div.addEventListener("click", () => {
          const confirmLoad = confirm("Deseja continuar a partir deste histórico?");
          if (confirmLoad) {
            loadFromHistory(s);
          }
        });
        historyEl.appendChild(div);
      });
    }

    function startTimer() {
      startTime = Date.now();
      isRunning = true;
      marks = [];
      lastClickTime = null;
      interval = setInterval(updateTimer, 10);
      currentSession = { date: new Date().toLocaleString(), marks: [] };
    }

    function recordMark() {
      const elapsed = Date.now() - startTime;
      const diff = lastClickTime !== null ? elapsed - lastClickTime : 0;
      lastClickTime = elapsed;
      const mark = { time: elapsed, diff };
      marks.push(mark);
      currentSession.marks.push(mark);
      updateMarksDisplay();
    }

    function stopTimer() {
      isRunning = false;
      clearInterval(interval);
    }

    function pause() {
      if (isRunning) {
        stopTimer();
        showPauseDialog();
        saveToHistory();
      }
    }

    function showPauseDialog() {
      document.getElementById("pauseDialog").style.display = "block";
    }

    function hidePauseDialog() {
      document.getElementById("pauseDialog").style.display = "none";
    }

    function resumeTimer() {
      hidePauseDialog();
      startTime = Date.now() - lastClickTime;
      isRunning = true;
      interval = setInterval(updateTimer, 10);
    }

    function deleteTimer() {
      stopTimer();
      hidePauseDialog();
      timerEl.textContent = "00:00.000";
      marksEl.innerHTML = "";
      currentSession = null;
    }

    function saveToHistory() {
      if (currentSession) {
        history.push(currentSession);
        localStorage.setItem("history", JSON.stringify(history));
        updateHistoryDisplay();
      }
    }

    function loadFromHistory(session) {
      stopTimer();
      timerEl.textContent = formatTime(session.marks[session.marks.length - 1]?.time || 0);
      marks = [...session.marks];
      lastClickTime = marks.length ? marks[marks.length - 1].time : 0;
      currentSession = JSON.parse(JSON.stringify(session));
      updateMarksDisplay();
      startTime = Date.now() - lastClickTime;
      interval = setInterval(updateTimer, 10);
      isRunning = true;
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      themeButton.textContent = isDark ? "Light" : "Dark";
    }

    updateHistoryDisplay();

    document.body.addEventListener("touchstart", (e) => {
      if (e.target.id === "timer") {
        longPressTimer = setTimeout(() => {
          pause();
        }, 700);
      }
    });

    document.body.addEventListener("touchend", () => {
      clearTimeout(longPressTimer);
    });

    document.body.addEventListener("click", (e) => {
      if (
        e.target.closest("#pauseDialog") ||
        e.target.id === "pauseButton" ||
        e.target.id === "themeButton"
      ) return;

      if (e.target.id === "timer") {
        if (!isRunning) {
          startTimer();
        } else {
          recordMark();
        }
      }
    });
  </script>
</body>
</html>
